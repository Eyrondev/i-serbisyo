<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - iSerbisyo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',                           
                            800: '#1e40af',
                            900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50">
    <div class="min-h-screen flex">
        <!-- Sidebar Container -->
        <div class="hidden lg:block">
            {% include 'components/admin-sidebar.html' %}
        </div>

        <!-- Main Content Wrapper -->
        <div class="flex-1 lg:pl-64">
            <!-- Header Container -->
            {% include 'components/admin-header.html' %}

            <!-- Main Dashboard Content -->
            <main class="flex-1 relative overflow-y-auto focus:outline-none">
                <!-- Dashboard Content -->
                <div class="py-3 sm:py-4 lg:py-6">
                    <div class="max-w-full mx-auto px-3 sm:px-4 lg:px-6 xl:px-8">
                        <!-- Modern Page Header -->
                        <div class="mb-8">
                            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                                    <div class="flex items-center space-x-4 mb-4 lg:mb-0">
                                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                            <i class="fas fa-tachometer-alt text-white text-2xl"></i>
                                        </div>
                                        <div>
                                            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-600 bg-clip-text text-transparent">
                                                Dashboard
                                            </h1>
                                            <p class="text-gray-600 text-lg">Welcome back! Here's what's happening in your barangay today</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modern Stats Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
                            <!-- Total Residents -->
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 overflow-hidden shadow-lg rounded-xl hover:shadow-xl transition-all duration-300 border border-blue-200 group">
                                <div class="p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-blue-600 uppercase tracking-wide">Total Residents</p>
                                            <p class="text-3xl font-bold text-blue-900 mt-2">{{ stats.total_residents | default(0) | number_format }}</p>
                                            <div class="flex items-center mt-2">
                                                <i class="fas fa-users text-blue-500 text-xs mr-1"></i>
                                                <p class="text-sm text-blue-600 font-medium">Approved residents</p>
                                            </div>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <div class="w-16 h-16 bg-blue-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                                <i class="fas fa-users text-white text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pending Requests -->
                            <div class="bg-gradient-to-br from-amber-50 to-amber-100 overflow-hidden shadow-lg rounded-xl hover:shadow-xl transition-all duration-300 border border-amber-200 group">
                                <div class="p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-amber-600 uppercase tracking-wide">Pending Requests</p>
                                            <p class="text-3xl font-bold text-amber-900 mt-2">{{ stats.pending_requests | default(0) }}</p>
                                            <div class="flex items-center mt-2">
                                                <i class="fas fa-clock text-amber-500 text-xs mr-1"></i>
                                                <p class="text-sm text-amber-600 font-medium">Awaiting review</p>
                                            </div>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <div class="w-16 h-16 bg-amber-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                                <i class="fas fa-clock text-white text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Monthly Revenue -->
                            <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 overflow-hidden shadow-lg rounded-xl hover:shadow-xl transition-all duration-300 border border-emerald-200 group">
                                <div class="p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-emerald-600 uppercase tracking-wide">Monthly Revenue</p>
                                            <p class="text-3xl font-bold text-emerald-900 mt-2">₱{{ "{:,.2f}".format(stats.monthly_revenue | default(0)) }}</p>
                                            <div class="flex items-center mt-2">
                                                {% set rev_change = stats.revenue_change | default(0) %}
                                                {% if rev_change >= 0 %}
                                                    <i class="fas fa-arrow-up text-green-500 text-xs mr-1"></i>
                                                    <p class="text-sm text-green-600 font-medium">+{{ rev_change }}% from last month</p>
                                                {% else %}
                                                    <i class="fas fa-arrow-down text-red-500 text-xs mr-1"></i>
                                                    <p class="text-sm text-red-600 font-medium">{{ rev_change }}% from last month</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <div class="w-16 h-16 bg-emerald-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                                <i class="fas fa-peso-sign text-white text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Announcements This Week -->
                            <div class="bg-gradient-to-br from-violet-50 to-violet-100 overflow-hidden shadow-lg rounded-xl hover:shadow-xl transition-all duration-300 border border-violet-200 group">
                                <div class="p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-violet-600 uppercase tracking-wide">Total Announcements</p>
                                            <p class="text-3xl font-bold text-violet-900 mt-2">{{ stats.weekly_announcements | default(0) }}</p>
                                            <div class="flex items-center mt-2">
                                                <i class="fas fa-calendar-week text-violet-500 text-xs mr-1"></i>
                                                <p class="text-sm text-violet-600 font-medium">This week</p>
                                            </div>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <div class="w-16 h-16 bg-violet-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                                <i class="fas fa-bullhorn text-white text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modern Charts and Activity Section -->
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
                            <!-- Service Requests Chart -->
                            <div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-all duration-300 border border-gray-100 flex flex-col">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-900">Service Requests</h3>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                        <span class="text-sm text-gray-600">Monthly Trend</span>
                                    </div>
                                </div>
                                <div class="flex-1 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-lg p-4" style="min-height: 220px; max-height: 220px;">
                                    <canvas id="requestsChart" 
                                            class="w-full h-full"
                                            data-labels='{{ stats.monthly_labels | tojson }}'
                                            data-values='{{ stats.monthly_chart_data | tojson }}'></canvas>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between text-sm">
                                    <span class="text-gray-600">This month: {{ stats.monthly_requests | default(0) }} requests</span>
                                    {% set change = stats.requests_change | default(0) %}
                                    <span class="font-medium {% if change >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                        {% if change >= 0 %}
                                            <i class="fas fa-arrow-up text-xs mr-1"></i>+{{ change }}%
                                        {% else %}
                                            <i class="fas fa-arrow-down text-xs mr-1"></i>{{ change }}%
                                        {% endif %}
                                        <span class="text-gray-500 text-xs ml-1">vs last month</span>
                                    </span>
                                </div>
                            </div>

                            <!-- Revenue Chart -->
                            <div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-all duration-300 border border-gray-100 flex flex-col">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-900">Revenue Analytics</h3>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 bg-emerald-500 rounded-full"></div>
                                        <span class="text-sm text-gray-600">Monthly</span>
                                    </div>
                                </div>
                                <div class="flex-1 bg-gradient-to-br from-emerald-50 to-green-100 rounded-lg p-4" style="min-height: 220px; max-height: 220px;">
                                    <canvas id="revenueChart" class="w-full h-full"></canvas>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Monthly target: ₱50,000</span>
                                    <span class="text-green-600 font-medium">{{ "%.0f" | format((stats.monthly_revenue / 50000 * 100) if stats.monthly_revenue else 0) }}% achieved</span>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-white shadow-lg rounded-xl border border-gray-100 hover:shadow-xl transition-all duration-300">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="text-lg font-bold text-gray-900">Recent Activity</h3>
                            </div>
                            <div class="divide-y divide-gray-100 max-h-96 overflow-y-auto">
                                <!-- Recent Certificate Requests -->
                                {% for certificate in recent_certificates %}
                                <div class="px-6 py-4 flex items-center space-x-4 hover:bg-gray-50 transition-colors">
                                    <div class="h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        {% if certificate.status == 'claimed' %}
                                            <i class="fas fa-check text-green-600"></i>
                                        {% elif certificate.status == 'ready' %}
                                            <i class="fas fa-file-check text-blue-600"></i>
                                        {% elif certificate.status == 'processing' %}
                                            <i class="fas fa-cog text-amber-600"></i>
                                        {% else %}
                                            <i class="fas fa-file-alt text-blue-600"></i>
                                        {% endif %}
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-medium text-gray-900">{{ certificate.certificate_type.replace('_', ' ').title() }} request</p>
                                        <p class="text-sm text-gray-500">{{ certificate.resident.full_name }} • Status: {{ certificate.status.title() }}</p>
                                        <p class="text-xs text-gray-400 mt-1">{{ certificate.request_date.strftime('%B %d, %Y at %I:%M %p') }}</p>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Recent Pending Residents -->
                                {% for resident in recent_residents %}
                                <div class="px-6 py-4 flex items-center space-x-4 hover:bg-gray-50 transition-colors">
                                    <div class="h-10 w-10 bg-amber-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-user-clock text-amber-600"></i>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-medium text-gray-900">New resident registration</p>
                                        <p class="text-sm text-gray-500">{{ resident.full_name }} • Pending approval</p>
                                        <p class="text-xs text-gray-400 mt-1">{{ resident.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Recent Approved Residents -->
                                {% for resident in recent_approved %}
                                <div class="px-6 py-4 flex items-center space-x-4 hover:bg-gray-50 transition-colors">
                                    <div class="h-10 w-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-user-check text-green-600"></i>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-medium text-gray-900">Resident approved</p>
                                        <p class="text-sm text-gray-500">{{ resident.full_name }} • Registration completed</p>
                                        <p class="text-xs text-gray-400 mt-1">{{ resident.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                                    </div>
                                </div>
                                {% endfor %}

                                {% if not recent_certificates and not recent_residents and not recent_approved %}
                                <div class="px-6 py-8 text-center">
                                    <i class="fas fa-inbox text-gray-400 text-3xl mb-2"></i>
                                    <p class="text-gray-500">No recent activity</p>
                                </div>
                                {% endif %}
                            </div>
                            <div class="px-6 py-4 border-t border-gray-200">
                                <a href="{{ url_for('admin.activity_log') }}" class="w-full text-center text-sm text-blue-600 hover:text-blue-800 font-medium inline-flex items-center justify-center py-2 rounded-lg hover:bg-blue-50 transition-all duration-200">
                                    <i class="fas fa-history mr-2"></i>
                                    View All Activities
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Dashboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
        });
        
        function initCharts() {
            // Requests Chart - Using real database data
            const requestsCtx = document.getElementById('requestsChart');
            if (requestsCtx) {
                // Get data from backend via data attributes
                const monthlyLabels = JSON.parse(requestsCtx.dataset.labels || '[]');
                const monthlyData = JSON.parse(requestsCtx.dataset.values || '[]');
                
                // Debug: Log the data to console
                console.log('Monthly Labels:', monthlyLabels);
                console.log('Monthly Data:', monthlyData);
                
                // Check if data exists
                if (!monthlyLabels.length || !monthlyData.length) {
                    console.warn('No chart data available');
                    // Show empty state in chart
                    requestsCtx.parentElement.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <i class="fas fa-chart-line text-gray-300 text-4xl mb-2"></i>
                                <p class="text-gray-500 text-sm">No data available</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                new Chart(requestsCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyLabels,
                        datasets: [{
                            label: 'Service Requests',
                            data: monthlyData,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#3B82F6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#3B82F6',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: false,
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        return `${context.parsed.y} requests`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(59, 130, 246, 0.1)',
                                    borderColor: 'rgba(59, 130, 246, 0.2)'
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        size: 12
                                    },
                                    stepSize: 1,
                                    precision: 0
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(59, 130, 246, 0.1)',
                                    borderColor: 'rgba(59, 130, 246, 0.2)'
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
            
            // Revenue Chart - Load data from API
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                // Show loading state
                const chartContainer = revenueCtx.parentElement;
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-emerald-50 rounded-lg';
                loadingDiv.innerHTML = '<div class="text-emerald-600"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Loading revenue data...</p></div>';
                chartContainer.style.position = 'relative';
                chartContainer.appendChild(loadingDiv);

                // Fetch revenue data from API
                fetch('{{ url_for("admin.revenue_analytics_api") }}')
                    .then(response => response.json())
                    .then(result => {
                        // Remove loading indicator
                        if (loadingDiv) {
                            loadingDiv.remove();
                        }

                        // Log debug information to console
                        console.log('Revenue API Response:', result);

                        if (result.success) {
                            const data = result.data;
                            
                            // Log the data we're about to chart
                            console.log('Chart Data:', {
                                labels: data.labels,
                                revenue: data.revenue,
                                total_revenue: data.total_revenue
                            });

                            // Log debug info if available
                            if (result.debug) {
                                console.log('Debug Info:', result.debug);
                                console.log('Payments found:', result.debug.payments_data);
                                console.log('Certificates found:', result.debug.certificates_data);
                            }
                            
                            new Chart(revenueCtx, {
                                type: 'bar',
                                data: {
                                    labels: data.labels,
                                    datasets: [{
                                        label: 'Revenue',
                                        data: data.revenue,
                                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                        borderColor: '#10B981',
                                        borderWidth: 2,
                                        borderRadius: 6,
                                        borderSkipped: false,
                                        hoverBackgroundColor: '#10B981',
                                        hoverBorderColor: '#059669'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: false
                                        },
                                        tooltip: {
                                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                            titleColor: '#ffffff',
                                            bodyColor: '#ffffff',
                                            borderColor: '#10B981',
                                            borderWidth: 1,
                                            cornerRadius: 8,
                                            displayColors: false,
                                            callbacks: {
                                                title: function(context) {
                                                    return context[0].label;
                                                },
                                                label: function(context) {
                                                    return '₱' + context.parsed.y.toLocaleString('en-PH', {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2
                                                    });
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            grid: {
                                                color: 'rgba(16, 185, 129, 0.1)',
                                                borderColor: 'rgba(16, 185, 129, 0.2)'
                                            },
                                            ticks: {
                                                color: '#6B7280',
                                                font: {
                                                    size: 12
                                                },
                                                callback: function(value) {
                                                    // Show exact values for small amounts
                                                    if (value >= 1000) {
                                                        return '₱' + (value / 1000) + 'k';
                                                    } else if (value > 0) {
                                                        return '₱' + value.toFixed(0);
                                                    } else {
                                                        return '₱0';
                                                    }
                                                }
                                            }
                                        },
                                        x: {
                                            grid: {
                                                color: 'rgba(16, 185, 129, 0.1)',
                                                borderColor: 'rgba(16, 185, 129, 0.2)'
                                            },
                                            ticks: {
                                                color: '#6B7280',
                                                font: {
                                                    size: 12
                                                }
                                            }
                                        }
                                    },
                                    interaction: {
                                        intersect: false,
                                        mode: 'index'
                                    }
                                }
                            });
                        } else {
                            console.error('API Error:', result.message);
                            if (result.debug) {
                                console.error('Debug Info:', result.debug);
                            }
                            // Show error state
                            chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading revenue data: ' + result.message + '</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching revenue data:', error);
                        // Remove loading indicator
                        if (loadingDiv) {
                            loadingDiv.remove();
                        }
                        // Show fallback chart with sample data
                        new Chart(revenueCtx, {
                            type: 'bar',
                            data: {
                                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                                datasets: [{
                                    label: 'Revenue',
                                    data: [0, 0, 0, 0, 0, 0],
                                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                    borderColor: '#10B981',
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    borderSkipped: false,
                                    hoverBackgroundColor: '#10B981',
                                    hoverBorderColor: '#059669'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(16, 185, 129, 0.1)',
                                            borderColor: 'rgba(16, 185, 129, 0.2)'
                                        }
                                    },
                                    x: {
                                        grid: {
                                            color: 'rgba(16, 185, 129, 0.1)',
                                            borderColor: 'rgba(16, 185, 129, 0.2)'
                                        }
                                    }
                                }
                            }
                        });
                    });
            }
        }
    </script>
    
    <!-- Main JavaScript -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>