<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Log - iSerbisyo Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',                           
                            800: '#1e40af',
                            900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50">
    <div class="min-h-screen flex">
        <!-- Sidebar Container -->
        <div class="hidden lg:block">
            {% include 'components/admin-sidebar.html' %}
        </div>

        <!-- Main Content Wrapper -->
        <div class="flex-1 lg:pl-64">
            <!-- Header Container -->
            {% include 'components/admin-header.html' %}

            <!-- Main Content -->
            <main class="flex-1 relative overflow-y-auto focus:outline-none">
                <div class="py-3 sm:py-4 lg:py-6">
                    <div class="max-w-full mx-auto px-3 sm:px-4 lg:px-6 xl:px-8">
                        <!-- Page Header -->
                        <div class="mb-6">
                            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                                    <div class="flex items-center space-x-4 mb-4 lg:mb-0">
                                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                            <i class="fas fa-history text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h1 class="text-2xl font-bold text-gray-900">Activity Log</h1>
                                            <p class="text-gray-600 mt-1">Monitor all system activities and user actions</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-3">
                                        <button onclick="exportLog()" class="inline-flex items-center px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white text-sm font-medium rounded-lg hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 shadow-lg hover:shadow-xl transition-all duration-300">
                                            <i class="fas fa-download mr-2"></i>
                                            Export Log
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-filter mr-2 text-blue-500"></i>
                                Filter Activities
                            </h3>
                            
                            <form method="GET" id="activityFilterForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <!-- Activity Type Filter -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Activity Type</label>
                                    <select name="type" id="typeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">All Types</option>
                                        {% for activity_type in activity_types %}
                                        <option value="{{ activity_type }}" 
                                                {% if current_filters.type == activity_type %}selected{% endif %}>
                                            {{ activity_type.replace('_', ' ').title() }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Date From -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                                    <input type="date" name="date_from" id="dateFromFilter" value="{{ current_filters.date_from }}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Date To -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                                    <input type="date" name="date_to" id="dateToFilter" value="{{ current_filters.date_to }}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- User Filter -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                                    <select name="user" id="userFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">All Users</option>
                                        {% for user in active_users %}
                                        <option value="{{ user.id }}" 
                                                {% if current_filters.user == user.id %}selected{% endif %}>
                                            {{ user.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Filter Buttons -->
                                <div class="md:col-span-2 lg:col-span-4 flex gap-3">
                                    <a href="{{ url_for('admin.activity_log') }}" class="inline-flex items-center px-6 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">
                                        <i class="fas fa-times mr-2"></i>
                                        Clear Filters
                                    </a>
                                </div>
                            </form>
                        </div>

                        <!-- Activity List -->
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                                <h3 class="text-lg font-semibold text-gray-900">
                                    Recent Activities 
                                    <span class="text-sm font-normal text-gray-500">({{ activities.total }} total)</span>
                                </h3>
                            </div>

                            {% if activities.items %}
                            <div class="divide-y divide-gray-100">
                                {% for activity in activities.items %}
                                <div class="px-6 py-4 hover:bg-gray-50 transition-colors">
                                    <div class="flex items-start space-x-4">
                                        <!-- Activity Icon -->
                                        <div class="flex-shrink-0">
                                            {% set icon_class = {
                                                'resident_approval': 'fa-user-check text-green-600 bg-green-100',
                                                'resident_rejection': 'fa-user-times text-red-600 bg-red-100',
                                                'certificate_request': 'fa-file-alt text-blue-600 bg-blue-100',
                                                'payment_received': 'fa-credit-card text-emerald-600 bg-emerald-100',
                                                'certificate_claimed': 'fa-check-circle text-green-600 bg-green-100',
                                                'resident_registration': 'fa-user-plus text-blue-600 bg-blue-100',
                                                'document_uploaded': 'fa-upload text-purple-600 bg-purple-100',
                                                'login': 'fa-sign-in-alt text-gray-600 bg-gray-100',
                                                'logout': 'fa-sign-out-alt text-gray-600 bg-gray-100',
                                                'announcement_posted': 'fa-bullhorn text-orange-600 bg-orange-100',
                                                'system_backup': 'fa-database text-indigo-600 bg-indigo-100'
                                            } %}
                                            
                                            {% set activity_icon = icon_class.get(activity.activity_type, 'fa-circle text-gray-600 bg-gray-100') %}
                                            
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center {{ activity_icon.split(' ', 2)[2] }}">
                                                <i class="fas {{ activity_icon.split(' ', 1)[0] }} {{ activity_icon.split(' ', 2)[1]}}"></i>
                                            </div>
                                        </div>

                                        <!-- Activity Details -->
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between">
                                                <p class="text-sm font-medium text-gray-900">
                                                    {{ activity.description }}
                                                </p>
                                                <time class="text-xs text-gray-500 flex-shrink-0 ml-4">
                                                    {{ activity.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                                                </time>
                                            </div>
                                            
                                            <div class="mt-1 flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="inline-flex items-center">
                                                    <i class="fas fa-tag mr-1"></i>
                                                    {{ activity.activity_type.replace('_', ' ').title() }}
                                                </span>
                                                
                                                {% if activity.user %}
                                                <span class="inline-flex items-center">
                                                    <i class="fas fa-user mr-1"></i>
                                                    {{ activity.user.name }}
                                                </span>
                                                {% endif %}
                                                
                                                {% if activity.target_type and activity.target_id %}
                                                <span class="inline-flex items-center">
                                                    <i class="fas fa-bullseye mr-1"></i>
                                                    {{ activity.target_type.title() }} #{{ activity.target_id }}
                                                </span>
                                                {% endif %}
                                                
                                                {% if activity.ip_address %}
                                                <span class="inline-flex items-center">
                                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                                    {{ activity.ip_address }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Pagination -->
                            {% if activities.pages > 1 %}
                            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-700">
                                        Showing {{ activities.per_page * (activities.page - 1) + 1 }} to 
                                        {{ activities.per_page * (activities.page - 1) + activities.items|length }} 
                                        of {{ activities.total }} results
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        {% if activities.has_prev %}
                                        <a href="{{ url_for('admin.activity_log', page=activities.prev_num, **current_filters) }}" 
                                           class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                            Previous
                                        </a>
                                        {% endif %}
                                        
                                        {% for page_num in activities.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                            {% if page_num %}
                                                {% if page_num != activities.page %}
                                                <a href="{{ url_for('admin.activity_log', page=page_num, **current_filters) }}" 
                                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                                    {{ page_num }}
                                                </a>
                                                {% else %}
                                                <span class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium">
                                                    {{ page_num }}
                                                </span>
                                                {% endif %}
                                            {% else %}
                                            <span class="px-3 py-2 text-gray-500">...</span>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if activities.has_next %}
                                        <a href="{{ url_for('admin.activity_log', page=activities.next_num, **current_filters) }}" 
                                           class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                            Next
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% else %}
                            <!-- Empty State -->
                            <div class="px-6 py-12 text-center">
                                <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No activities found</h3>
                                <p class="text-gray-500 mb-4">
                                    {% if current_filters.type or current_filters.date_from or current_filters.date_to or current_filters.user %}
                                        No activities match your current filters. Try adjusting your search criteria.
                                    {% else %}
                                        There are no activities logged in the system yet.
                                    {% endif %}
                                </p>
                                {% if current_filters.type or current_filters.date_from or current_filters.date_to or current_filters.user %}
                                <a href="{{ url_for('admin.activity_log') }}" 
                                   class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-times mr-2"></i>
                                    Clear Filters
                                </a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        function exportLog() {
            alert('Export functionality would be implemented here. This would generate a downloadable report of all activities.');
        }

        // Automatic filtering
        document.addEventListener('DOMContentLoaded', function() {
            const filterForm = document.getElementById('activityFilterForm');
            const typeFilter = document.getElementById('typeFilter');
            const dateFromFilter = document.getElementById('dateFromFilter');
            const dateToFilter = document.getElementById('dateToFilter');
            const userFilter = document.getElementById('userFilter');

            // Auto-submit on dropdown change
            if (typeFilter) {
                typeFilter.addEventListener('change', function() {
                    filterForm.submit();
                });
            }

            if (userFilter) {
                userFilter.addEventListener('change', function() {
                    filterForm.submit();
                });
            }

            // Auto-submit on date change
            if (dateFromFilter) {
                dateFromFilter.addEventListener('change', function() {
                    filterForm.submit();
                });
            }

            if (dateToFilter) {
                dateToFilter.addEventListener('change', function() {
                    filterForm.submit();
                });
            }
        });
    </script>
    
    <!-- Main JavaScript -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>