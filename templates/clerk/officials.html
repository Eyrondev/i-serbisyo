<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Officials Management - iSerBisyo Clerk</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/iserbisyo_icon.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',                           
                            800: '#1e40af',
                            900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50">
    <div class="min-h-screen flex">
        <!-- Sidebar Container -->
        <div class="hidden lg:block">
            {% include 'components/clerk-sidebar.html' %}
        </div>

        <!-- Main Content Wrapper -->
        <div class="flex-1 lg:pl-64">
            <!-- Header Container -->
            {% include 'components/clerk-header.html' %}

            <!-- Main content area -->
            <main class="flex-1 relative overflow-y-auto focus:outline-none">
                <!-- Officials Content -->
                <div class="py-3 sm:py-4 lg:py-6">
                    <div class="max-w-full mx-auto px-3 sm:px-4 lg:px-6 xl:px-8">
                        <!-- Modern Page Header -->
                        <div class="mb-8">
                            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                                    <div class="flex items-center space-x-4 mb-4 lg:mb-0">
                                        <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                            <i class="fas fa-user-tie text-white text-2xl"></i>
                                        </div>
                                        <div>
                                            <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                                                Officials Management
                                            </h1>
                                            <p class="text-gray-600 text-lg">Manage barangay officials and their roles</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-3">
                                        <button class="add-official-btn inline-flex items-center px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-sm font-medium rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 shadow-lg hover:shadow-xl transition-all duration-300">
                                            <i class="fas fa-plus mr-2"></i>
                                            Add Official
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modern Officials Stats - Full Width -->
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
                            <!-- Total Officials -->
                            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 overflow-hidden shadow-lg rounded-xl hover:shadow-xl transition-all duration-300 border border-indigo-200 group">
                                <div class="p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-indigo-600 uppercase tracking-wide">Total Officials</p>
                                            <p class="text-3xl font-bold text-indigo-900 mt-2">{{ stats.total_officials | default(0) }}</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <div class="w-16 h-16 bg-indigo-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                                <i class="fas fa-users text-white text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Active Term -->
                            <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 overflow-hidden shadow-lg rounded-xl hover:shadow-xl transition-all duration-300 border border-emerald-200 group">
                                <div class="p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-emerald-600 uppercase tracking-wide">Active Term</p>
                                            <p class="text-3xl font-bold text-emerald-900 mt-2">{{ stats.current_term | default('2023-2026') }}</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <div class="w-16 h-16 bg-emerald-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                                <i class="fas fa-calendar text-white text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Next Elections -->
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 overflow-hidden shadow-lg rounded-xl hover:shadow-xl transition-all duration-300 border border-purple-200 group">
                                <div class="p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-purple-600 uppercase tracking-wide">Next Elections</p>
                                            <p class="text-3xl font-bold text-purple-900 mt-2">{{ stats.next_election | default('May 2026') }}</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <div class="w-16 h-16 bg-purple-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                                <i class="fas fa-vote-yea text-white text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vacant Positions -->
                            <div class="bg-gradient-to-br from-amber-50 to-amber-100 overflow-hidden shadow-lg rounded-xl hover:shadow-xl transition-all duration-300 border border-amber-200 group">
                                <div class="p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-amber-600 uppercase tracking-wide">Vacant Positions</p>
                                            <p class="text-3xl font-bold text-amber-900 mt-2">{{ stats.vacant_positions | default(0) }}</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <div class="w-16 h-16 bg-amber-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                                <i class="fas fa-exclamation text-white text-xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modern Filters and Actions -->
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6">
                            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                                <!-- Filters -->
                                <div class="flex flex-wrap items-center gap-3">
                                    <div class="relative">
                                        <select id="positionFilter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 pr-8 hover:bg-gray-100 transition-colors">
                                            <option value="">All Positions</option>
                                            <option value="Barangay Captain">Barangay Captain</option>
                                            <option value="Barangay Kagawad">Barangay Kagawad</option>
                                            <option value="Secretary">Secretary</option>
                                            <option value="Treasurer">Treasurer</option>
                                            <option value="SK Chairman">SK Chairman</option>
                                        </select>
                                    </div>
                                    
                                    <div class="relative">
                                        <select id="committeeFilter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 pr-8 hover:bg-gray-100 transition-colors">
                                            <option value="">All Committees</option>
                                            <option value="Presiding Officer">Presiding Officer</option>
                                            <option value="Committee on Appropriation">Appropriation</option>
                                            <option value="Committee on Peace & Order">Peace & Order</option>
                                            <option value="Committee on Health">Health</option>
                                            <option value="Committee on Education">Education</option>
                                            <option value="Committee on Sports">Sports</option>
                                            <option value="No Chairmanship">No Committee</option>
                                        </select>
                                    </div>
                                    
                                    <div class="relative">
                                        <select id="statusFilter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 pr-8 hover:bg-gray-100 transition-colors">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div class="relative">
                                        <input type="text" id="searchInput" placeholder="Search officials..." 
                                               class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 p-2.5 hover:bg-gray-100 transition-colors">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-search text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Officials Grid -->
                        <div id="officialsGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-3 mb-4">
                            {% if officials %}
                            {% for official in officials %}
                            <div class="official-card bg-white shadow-sm rounded-lg border border-gray-100 p-4" 
                                 data-name="{{ official.name.lower() }}" 
                                 data-position="{{ official.position }}" 
                                 data-committee="{{ official.committee or 'No Chairmanship' }}" 
                                 data-status="active"
                                 data-phone="{{ official.phone or '' }}"
                                 data-email="{{ official.email or '' }}">
                                <div class="flex items-center space-x-3">
                                    <div class="h-12 w-12 rounded-full bg-gradient-to-r 
                                        {% if 'Captain' in official.position %}from-blue-500 to-blue-600
                                        {% elif 'Kagawad' in official.position %}from-green-500 to-green-600
                                        {% elif 'Secretary' in official.position %}from-purple-500 to-purple-600
                                        {% elif 'Treasurer' in official.position %}from-yellow-500 to-yellow-600
                                        {% elif 'SK' in official.position %}from-red-500 to-red-600
                                        {% else %}from-gray-500 to-gray-600{% endif %} 
                                        flex items-center justify-center overflow-hidden">
                                        {% if official.profile_picture %}
                                            <img src="{{ url_for('static', filename='uploads/profiles/' + official.profile_picture) }}" 
                                                 alt="{{ official.name }}" 
                                                 class="w-full h-full object-cover">
                                        {% else %}
                                            <span class="text-sm font-bold text-white">
                                                {{ official.name.split()[0][0] if official.name.split() else 'O' }}{{ official.name.split()[1][0] if official.name.split()|length > 1 else '' }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-sm font-semibold text-gray-900 truncate">{{ official.name }}</h3>
                                        <p class="text-xs 
                                            {% if 'Captain' in official.position %}text-blue-600
                                            {% elif 'Kagawad' in official.position %}text-green-600
                                            {% elif 'Secretary' in official.position %}text-purple-600
                                            {% elif 'Treasurer' in official.position %}text-yellow-600
                                            {% elif 'SK' in official.position %}text-red-600
                                            {% else %}text-gray-600{% endif %} 
                                            font-medium">{{ official.position }}</p>
                                        <p class="text-xs text-gray-500">
                                            {% if official.committee and official.committee != 'No Chairmanship' %}
                                                {{ official.committee.replace('Committee on ', '') if 'Committee on' in official.committee else official.committee }}
                                            {% elif official.term_start and official.term_end %}
                                                Term: {{ official.term_start.strftime('%Y') }}-{{ official.term_end.strftime('%Y') }}
                                            {% else %}
                                                Current Term
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="flex space-x-1">
                                        <button class="edit-official-btn text-blue-600 hover:text-blue-900 p-1" 
                                                data-official-id="{{ official.id }}" title="Edit">
                                            <i class="fas fa-edit text-xs"></i>
                                        </button>
                                        <button class="view-official-btn text-green-600 hover:text-green-900 p-1" 
                                                data-official-id="{{ official.id }}" title="View">
                                            <i class="fas fa-eye text-xs"></i>
                                        </button>
                                        <button class="delete-official-btn text-red-600 hover:text-red-900 p-1" 
                                                data-official-id="{{ official.id }}" title="Remove">
                                            <i class="fas fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-3 grid grid-cols-2 gap-3 text-xs">
                                    <div>
                                        <span class="text-gray-500">Contact:</span>
                                        <p class="text-gray-900 truncate">{{ official.phone or 'Not provided' }}</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Email:</span>
                                        <p class="text-gray-900 truncate">{{ official.email or 'Not provided' }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if stats.vacant_positions > 0 %}
                            <!-- Add Official Card -->
                            <div class="bg-gray-50 shadow-sm rounded-lg border border-gray-200 border-dashed p-4">
                                <div class="flex items-center justify-center h-full">
                                    <div class="text-center">
                                        <div class="h-12 w-12 rounded-full bg-gray-200 flex items-center justify-center mx-auto mb-2">
                                            <i class="fas fa-plus text-gray-400"></i>
                                        </div>
                                        <h3 class="text-sm font-medium text-gray-500">Add Official</h3>
                                        <p class="text-xs text-gray-400">{{ stats.vacant_positions }} vacant position{{ 's' if stats.vacant_positions != 1 else '' }}</p>
                                        <button class="add-official-btn mt-2 text-xs text-primary-600 hover:text-primary-800 font-medium">
                                            Add Official
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% else %}
                            <!-- Empty State -->
                            <div class="col-span-full bg-gray-50 rounded-lg p-8 text-center">
                                <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No officials found</h3>
                                <p class="text-gray-500 mb-4">Start by adding barangay officials to manage their information.</p>
                                <button class="add-official-btn inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700">
                                    <i class="fas fa-plus mr-2"></i>
                                    Add First Official
                                </button>
                            </div>
                            {% endif %}
                        </div>


                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Official Modal -->
    <div id="addOfficialModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-4 py-3 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Add New Official</h3>
                </div>
                <div class="p-4">
                    <form class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Profile Picture</label>
                            <div class="flex items-center space-x-4">
                                <div class="flex-shrink-0">
                                    <div id="profilePicturePreview" class="hidden w-16 h-16 rounded-full overflow-hidden border-2 border-gray-200">
                                        <img id="previewImage" src="" alt="Profile Preview" class="w-full h-full object-cover">
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <input type="file" name="profile_picture" id="profilePictureInput" accept="image/jpeg,image/jpg,image/png,image/gif" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                           onchange="previewProfilePicture(this)">
                                    <p class="text-xs text-gray-500 mt-1">JPG, PNG, or GIF. Max size: 5MB</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                            <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position *</label>
                            <select name="position" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Select Position</option>
                                <option value="Barangay Captain">Barangay Captain</option>
                                <option value="Barangay Kagawad">Barangay Kagawad</option>
                                <option value="Secretary">Secretary</option>
                                <option value="Treasurer">Treasurer</option>
                                <option value="SK Chairman">SK Chairman</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Committee</label>
                            <select name="committee" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Select Committee</option>
                                <option value="Presiding Officer">Presiding Officer</option>
                                <option value="Committee on Appropriation">Committee on Appropriation</option>
                                <option value="Committee on Peace & Order">Committee on Peace & Order</option>
                                <option value="Committee on Health">Committee on Health</option>
                                <option value="Committee on Education">Committee on Education</option>
                                <option value="Committee on Sports">Committee on Sports</option>
                                <option value="No Chairmanship">No Chairmanship</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
                                <input type="tel" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Term Start</label>
                            <input type="date" name="term_start" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </form>
                </div>
                <div class="px-4 py-3 border-t border-gray-200 flex justify-end space-x-2">
                    <button type="button" onclick="closeAddOfficialModal()" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="button" onclick="submitAddOfficialForm()" class="submit-btn px-3 py-2 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700">Add Official</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Official Modal -->
    <div id="viewOfficialModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Official Details</h3>
                        <button onclick="closeViewOfficialModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="flex items-center space-x-4 mb-6">
                        <div id="viewOfficialAvatar" class="h-16 w-16 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center overflow-hidden">
                            <img id="viewOfficialProfilePic" src="" alt="Profile" class="w-full h-full object-cover hidden">
                            <span id="viewOfficialInitials" class="text-lg font-bold text-white">RC</span>
                        </div>
                        <div class="flex-1">
                            <h4 id="viewOfficialName" class="text-xl font-semibold text-gray-900">Official Name</h4>
                            <p id="viewOfficialPosition" class="text-sm text-blue-600 font-medium">Position</p>
                            <p id="viewOfficialCommittee" class="text-sm text-gray-500">Committee</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
                                <p id="viewOfficialPhone" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">Not provided</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <p id="viewOfficialEmail" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">Not provided</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Term Start</label>
                                <p id="viewOfficialTermStart" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">Not specified</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Term End</label>
                                <p id="viewOfficialTermEnd" class="text-sm text-gray-900 bg-gray-50 px-3 py-2 rounded-lg">Not specified</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <span id="viewOfficialStatus" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Active
                            </span>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button onclick="closeViewOfficialModal()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">Close</button>
                    <button id="editFromViewBtn" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-edit mr-2"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize filtering functionality
            initializeFilters();
            
            // Add event listeners for all official management buttons
            
            // Add official buttons
            document.querySelectorAll('.add-official-btn').forEach(button => {
                button.addEventListener('click', function() {
                    openAddOfficialModal();
                });
            });

            // Edit official buttons
            document.querySelectorAll('.edit-official-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const officialId = this.getAttribute('data-official-id');
                    editOfficial(officialId);
                });
            });

            // View official buttons
            document.querySelectorAll('.view-official-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const officialId = this.getAttribute('data-official-id');
                    viewOfficial(officialId);
                });
            });

            // Delete official buttons
            document.querySelectorAll('.delete-official-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const officialId = this.getAttribute('data-official-id');
                    deleteOfficial(officialId);
                });
            });

            // Add official form submission (both form submit and button click)
            const addOfficialForm = document.querySelector('#addOfficialModal form');
            if (addOfficialForm) {
                addOfficialForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitAddOfficialForm();
                });
            }
            
            // Add official submit button click handler
            const submitBtn = document.querySelector('#addOfficialModal .submit-btn');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    submitAddOfficialForm();
                });
            }
        });

        function openAddOfficialModal() {
            const modal = document.getElementById('addOfficialModal');
            
            if (!modal) {
                alert('Edit modal not found. Please refresh the page.');
                return;
            }
            
            // Only clear form if it's not an edit operation (no data-official-id)
            const form = document.querySelector('#addOfficialModal form');
            const isEdit = form && form.hasAttribute('data-official-id');
            
            if (!isEdit && form) {
                form.reset();
            }
            
            modal.classList.remove('hidden');
        }

        function closeAddOfficialModal() {
            document.getElementById('addOfficialModal').classList.add('hidden');
            
            // Reset form and modal state
            const form = document.querySelector('#addOfficialModal form');
            if (form) {
                form.reset();
                form.removeAttribute('data-official-id');
            }
            
            // Reset profile picture preview
            const previewContainer = document.getElementById('profilePicturePreview');
            if (previewContainer) {
                previewContainer.classList.add('hidden');
            }
            
            // Reset modal title and button text
            document.querySelector('#addOfficialModal h3').textContent = 'Add New Official';
            document.querySelector('#addOfficialModal .submit-btn').textContent = 'Add Official';
        }

        function editOfficial(officialId) {
            // Fetch official data and populate modal  
            fetch(`/clerk/api/get-official/${officialId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Find the form
                    const form = document.querySelector('#addOfficialModal form');
                    
                    if (!form) {
                        alert('Edit form not found. Please refresh the page.');
                        return;
                    }
                    
                    // Populate form fields
                    const nameInput = form.querySelector('input[name="name"]');
                    const positionSelect = form.querySelector('select[name="position"]');
                    const committeeSelect = form.querySelector('select[name="committee"]');
                    const phoneInput = form.querySelector('input[name="phone"]');
                    const emailInput = form.querySelector('input[name="email"]');
                    
                    if (nameInput) nameInput.value = data.name || '';
                    if (positionSelect) positionSelect.value = data.position || '';
                    if (committeeSelect) committeeSelect.value = data.committee || '';
                    if (phoneInput) phoneInput.value = data.phone || '';
                    if (emailInput) emailInput.value = data.email || '';
                    
                    // Handle date formatting for term_start
                    const termStartInput = form.querySelector('input[name="term_start"]');
                    
                    if (termStartInput) {
                        if (data.term_start) {
                            // If the date is in ISO format, convert to YYYY-MM-DD for input[type="date"]
                            const termStart = data.term_start.includes('T') ? data.term_start.split('T')[0] : data.term_start;
                            termStartInput.value = termStart;
                        } else {
                            termStartInput.value = '';
                        }
                    }
                    
                    // Handle existing profile picture
                    const previewContainer = document.getElementById('profilePicturePreview');
                    const previewImage = document.getElementById('previewImage');
                    
                    if (data.profile_picture && previewContainer && previewImage) {
                        previewImage.src = `/static/uploads/profiles/${data.profile_picture}`;
                        previewContainer.classList.remove('hidden');
                    } else if (previewContainer) {
                        previewContainer.classList.add('hidden');
                    }
                    
                    // Change modal title and button
                    const modalTitle = document.querySelector('#addOfficialModal h3');
                    const submitBtn = document.querySelector('#addOfficialModal .submit-btn');
                    
                    if (modalTitle) modalTitle.textContent = 'Edit Official';
                    if (submitBtn) submitBtn.textContent = 'Update Official';
                    
                    // Store official ID for update
                    form.setAttribute('data-official-id', officialId);
                    
                    // Open the modal
                    openAddOfficialModal();
                })
                .catch(error => {
                    alert('Error loading official data: ' + error.message);
                });
        }

        function viewOfficial(officialId) {
            // Ensure DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => viewOfficial(officialId));
                return;
            }
            
            // Fetch and display official details in modal
            fetch(`/clerk/api/get-official/${officialId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Get modal elements
                    const nameEl = document.getElementById('viewOfficialName');
                    const positionEl = document.getElementById('viewOfficialPosition');
                    
                    if (!nameEl || !positionEl) {
                        alert('Modal elements not found. Please refresh the page.');
                        return;
                    }
                    
                    // Populate view modal with official data
                    nameEl.textContent = data.name;
                    positionEl.textContent = data.position;
                    
                    // Set committee information
                    const committeeEl = document.getElementById('viewOfficialCommittee');
                    if (committeeEl) {
                        if (data.committee && data.committee !== 'No Chairmanship') {
                            committeeEl.textContent = data.committee.replace('Committee on ', '');
                        } else {
                            committeeEl.textContent = 'No Committee Assignment';
                        }
                    }
                    
                    // Set contact information
                    const phoneEl = document.getElementById('viewOfficialPhone');
                    const emailEl = document.getElementById('viewOfficialEmail');
                    
                    if (phoneEl) phoneEl.textContent = data.phone || 'Not provided';
                    if (emailEl) emailEl.textContent = data.email || 'Not provided';
                    
                    // Set term information
                    const termStartEl = document.getElementById('viewOfficialTermStart');
                    const termEndEl = document.getElementById('viewOfficialTermEnd');
                    
                    if (termStartEl) {
                        termStartEl.textContent = data.term_start ? new Date(data.term_start).toLocaleDateString() : 'Not specified';
                    }
                    if (termEndEl) {
                        termEndEl.textContent = data.term_end ? new Date(data.term_end).toLocaleDateString() : 'Not specified';
                    }
                    
                    // Set avatar and initials
                    const nameParts = data.name.split(' ');
                    const initials = nameParts.length > 1 ? nameParts[0][0] + nameParts[1][0] : nameParts[0].substring(0, 2);
                    const initialsEl = document.getElementById('viewOfficialInitials');
                    const profilePicEl = document.getElementById('viewOfficialProfilePic');
                    
                    if (data.profile_picture && profilePicEl) {
                        profilePicEl.src = `/static/uploads/profiles/${data.profile_picture}`;
                        profilePicEl.classList.remove('hidden');
                        if (initialsEl) initialsEl.classList.add('hidden');
                    } else {
                        if (profilePicEl) profilePicEl.classList.add('hidden');
                        if (initialsEl) {
                            initialsEl.textContent = initials;
                            initialsEl.classList.remove('hidden');
                        }
                    }
                    
                    // Set avatar color based on position
                    const avatar = document.getElementById('viewOfficialAvatar');
                    if (avatar) {
                        avatar.className = 'h-16 w-16 rounded-full flex items-center justify-center ';
                        if (data.position.includes('Captain')) {
                            avatar.className += 'bg-gradient-to-r from-blue-500 to-blue-600';
                        } else if (data.position.includes('Kagawad')) {
                            avatar.className += 'bg-gradient-to-r from-green-500 to-green-600';
                        } else if (data.position.includes('Secretary')) {
                            avatar.className += 'bg-gradient-to-r from-purple-500 to-purple-600';
                        } else if (data.position.includes('Treasurer')) {
                            avatar.className += 'bg-gradient-to-r from-yellow-500 to-yellow-600';
                        } else if (data.position.includes('SK')) {
                            avatar.className += 'bg-gradient-to-r from-red-500 to-red-600';
                        } else {
                            avatar.className += 'bg-gradient-to-r from-gray-500 to-gray-600';
                        }
                    }
                    
                    // Set edit button to open edit modal with this official's data
                    const editBtn = document.getElementById('editFromViewBtn');
                    if (editBtn) {
                        editBtn.onclick = function() {
                            closeViewOfficialModal();
                            editOfficial(officialId);
                        };
                    }
                    
                    // Show the modal
                    const modal = document.getElementById('viewOfficialModal');
                    if (modal) {
                        modal.classList.remove('hidden');
                    } else {
                        alert('View modal not found. Please refresh the page.');
                    }
                })
                .catch(error => {
                    alert('Error loading official details: ' + error.message);
                });
        }

        function closeViewOfficialModal() {
            document.getElementById('viewOfficialModal').classList.add('hidden');
        }

        function deleteOfficial(officialId) {
            // Show confirmation dialog with SweetAlert2
            Swal.fire({
                title: 'Are you sure?',
                text: 'You want to remove this official? This action cannot be undone!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, remove it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/clerk/api/delete-official/${officialId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted!',
                                text: 'The official has been removed successfully.',
                                confirmButtonColor: '#3b82f6'
                            }).then(() => {
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: 'Error removing official: ' + data.message,
                                confirmButtonColor: '#ef4444'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Connection Error!',
                            text: 'An error occurred while removing the official.',
                            confirmButtonColor: '#ef4444'
                        });
                    });
                }
            });
        }

        function submitAddOfficialForm() {
            const form = document.querySelector('#addOfficialModal form');
            const officialId = form ? form.getAttribute('data-official-id') : null;
            
            if (!form) {
                alert('Form not found. Please refresh the page.');
                return;
            }
            
            // Use FormData for file uploads
            const formData = new FormData();
            formData.append('name', form.querySelector('input[name="name"]')?.value || '');
            formData.append('position', form.querySelector('select[name="position"]')?.value || '');
            formData.append('committee', form.querySelector('select[name="committee"]')?.value || '');
            formData.append('phone', form.querySelector('input[name="phone"]')?.value || '');
            formData.append('email', form.querySelector('input[name="email"]')?.value || '');
            formData.append('term_start', form.querySelector('input[name="term_start"]')?.value || '');
            
            // Add profile picture if selected
            const profilePictureInput = form.querySelector('input[name="profile_picture"]');
            if (profilePictureInput && profilePictureInput.files[0]) {
                formData.append('profile_picture', profilePictureInput.files[0]);
            }

            const url = officialId ? `/clerk/api/update-official/${officialId}` : '/clerk/api/add-official';
            const method = 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success notification with SweetAlert2
                    Swal.fire({
                        icon: 'success',
                        title: officialId ? 'Official Updated!' : 'Official Added!',
                        text: officialId ? 'The official information has been updated successfully.' : 'New official has been added successfully.',
                        confirmButtonColor: '#3b82f6',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        closeAddOfficialModal();
                        window.location.reload();
                    });
                } else {
                    // Show error notification
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.message || 'An error occurred while saving the official.',
                        confirmButtonColor: '#ef4444'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Show error notification for network/server errors
                Swal.fire({
                    icon: 'error',
                    title: 'Connection Error!',
                    text: 'An error occurred while saving the official. Please check your connection and try again.',
                    confirmButtonColor: '#ef4444'
                });
            });
        }

        function exportOfficials() {
            // Implement export functionality
            alert('Export functionality will be implemented based on your requirements.');
        }

        function initializeFilters() {
            const positionFilter = document.getElementById('positionFilter');
            const committeeFilter = document.getElementById('committeeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const searchInput = document.getElementById('searchInput');

            // Add event listeners for automatic filtering
            if (positionFilter) {
                positionFilter.addEventListener('change', filterOfficials);
            }
            if (committeeFilter) {
                committeeFilter.addEventListener('change', filterOfficials);
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', filterOfficials);
            }
            if (searchInput) {
                searchInput.addEventListener('input', debounce(filterOfficials, 300));
            }
        }

        function filterOfficials() {
            const positionFilter = document.getElementById('positionFilter')?.value || '';
            const committeeFilter = document.getElementById('committeeFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value.toLowerCase() || '';
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';

            const officialCards = document.querySelectorAll('.official-card');
            let visibleCount = 0;

            officialCards.forEach(card => {
                const name = card.getAttribute('data-name') || '';
                const position = card.getAttribute('data-position') || '';
                const committee = card.getAttribute('data-committee') || '';
                const status = card.getAttribute('data-status')?.toLowerCase() || '';
                const phone = card.getAttribute('data-phone')?.toLowerCase() || '';
                const email = card.getAttribute('data-email')?.toLowerCase() || '';

                let show = true;

                // Position filter
                if (positionFilter && position !== positionFilter) {
                    show = false;
                }

                // Committee filter
                if (committeeFilter && committee !== committeeFilter) {
                    show = false;
                }

                // Status filter
                if (statusFilter && status !== statusFilter) {
                    show = false;
                }

                // Search filter
                if (searchTerm) {
                    const searchableText = `${name} ${position.toLowerCase()} ${committee.toLowerCase()} ${phone} ${email}`;
                    if (!searchableText.includes(searchTerm)) {
                        show = false;
                    }
                }

                // Show/hide card
                if (show) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Update results count or show no results message
            updateFilterResults(visibleCount);
        }

        function clearFilters() {
            // Reset all filter controls
            const positionFilter = document.getElementById('positionFilter');
            const committeeFilter = document.getElementById('committeeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const searchInput = document.getElementById('searchInput');

            if (positionFilter) positionFilter.selectedIndex = 0;
            if (committeeFilter) committeeFilter.selectedIndex = 0;
            if (statusFilter) statusFilter.selectedIndex = 0;
            if (searchInput) searchInput.value = '';

            // Show all cards
            const officialCards = document.querySelectorAll('.official-card');
            officialCards.forEach(card => {
                card.style.display = 'block';
            });

            // Remove any filter results message
            const existingMessage = document.getElementById('filterResultsMessage');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Filters Cleared!',
                text: 'All filters have been reset.',
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        }

        function updateFilterResults(count) {
            // Remove existing message
            const existingMessage = document.getElementById('filterResultsMessage');
            if (existingMessage) {
                existingMessage.remove();
            }

            const officialsGrid = document.getElementById('officialsGrid');
            if (!officialsGrid) return;

            if (count === 0) {
                // Show no results message
                const noResultsMessage = document.createElement('div');
                noResultsMessage.id = 'filterResultsMessage';
                noResultsMessage.className = 'col-span-full bg-gray-50 rounded-lg p-8 text-center';
                noResultsMessage.innerHTML = `
                    <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No officials found</h3>
                    <p class="text-gray-500 mb-4">Try adjusting your filters or search terms.</p>
                    <button onclick="clearFilters()" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700">
                        <i class="fas fa-refresh mr-2"></i>
                        Clear Filters
                    </button>
                `;
                officialsGrid.appendChild(noResultsMessage);
            } else {
                // Show results count in a toast
                const totalCards = document.querySelectorAll('.official-card').length;
                if (count < totalCards) {
                    Swal.fire({
                        icon: 'info',
                        title: `${count} of ${totalCards} officials shown`,
                        timer: 2000,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end'
                    });
                }
            }
        }

        function toggleAdvancedFilters() {
            // This can be expanded to show/hide additional filter options
            Swal.fire({
                icon: 'info',
                title: 'Advanced Filters',
                text: 'Use the dropdown filters and search box to filter officials by position, committee, status, or search terms.',
                confirmButtonColor: '#3b82f6'
            });
        }

        // Utility function for debouncing search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Profile picture preview function
        function previewProfilePicture(input) {
            const preview = document.getElementById('profilePicturePreview');
            const previewImg = document.getElementById('previewImage');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({
                        icon: 'error',
                        title: 'File Too Large',
                        text: 'Please select an image smaller than 5MB.',
                        confirmButtonColor: '#ef4444'
                    });
                    input.value = '';
                    return;
                }
                
                // Validate file type
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                if (!validTypes.includes(file.type)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid File Type',
                        text: 'Please select a JPG, PNG, or GIF image.',
                        confirmButtonColor: '#ef4444'
                    });
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
            }
        }


    </script>

    <!-- Load clerk components -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>